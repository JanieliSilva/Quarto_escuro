<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - light probe from cubeCamera</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
		<style>
			body { margin: 0; }
			canvas { display: block; }
			#info { position: absolute; top: 10px; width: 100%; text-align: center; z-index: 100; color: white; }
		</style>
	</head>

	<body>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - light probe from cubeCamera
		</div>

		<script type="importmap">
			{
				"imports": {
					"three": "https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.module.js",
					"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.1/examples/jsm/"
				}
			}
		</script>

		<script type="module">

			import * as THREE from 'three';
			import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
			import { LightProbeHelper } from 'three/addons/helpers/LightProbeHelper.js';
			import { LightProbeGenerator } from 'three/addons/lights/LightProbeGenerator.js';

			let renderer, scene, camera, cubeCamera, lightProbe;

			init();

			function init() {

				// Renderer
				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize(window.innerWidth, window.innerHeight);
				document.body.appendChild(renderer.domElement);

				// Scene
				scene = new THREE.Scene();

				// Camera
				camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 1000);
				camera.position.set(0, 0, 30);

				// Cube render target for cube camera
				const cubeRenderTarget = new THREE.WebGLCubeRenderTarget(256);
				cubeCamera = new THREE.CubeCamera(1, 1000, cubeRenderTarget);

				// Controls
				const controls = new OrbitControls(camera, renderer.domElement);
				controls.addEventListener('change', render);
				controls.minDistance = 10;
				controls.maxDistance = 50;
				controls.enablePan = false;

				// Light probe
				lightProbe = new THREE.LightProbe();
				scene.add(lightProbe);

				// Load environment map (cube texture)
				const genCubeUrls = (prefix, postfix) => [
					prefix + 'px' + postfix, prefix + 'nx' + postfix,
					prefix + 'py' + postfix, prefix + 'ny' + postfix,
					prefix + 'pz' + postfix, prefix + 'nz' + postfix
				];

				const urls = genCubeUrls('https://threejs.org/examples/textures/cube/pisa/', '.png');

				new THREE.CubeTextureLoader().load(
					urls,
					(cubeTexture) => {
						scene.background = cubeTexture;
						cubeCamera.update(renderer, scene);

						lightProbe.copy(LightProbeGenerator.fromCubeRenderTarget(renderer, cubeRenderTarget));
						scene.add(new LightProbeHelper(lightProbe, 5));

						render();
					},
					undefined, // Progress callback
					() => {
						console.error('Failed to load environment map.');
					}
				);

				// Window resize listener
				window.addEventListener('resize', onWindowResize);

			}

			function onWindowResize() {
				renderer.setSize(window.innerWidth, window.innerHeight);
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				render();
			}

			function render() {
				renderer.render(scene, camera);
			}

		</script>

	</body>
</html>
